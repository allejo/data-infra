
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://docs.calitp.org/data-infra/kubernetes/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.5">
    
    
      
        <title>kubernetes # - Juniper Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.be71726b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css">
    
    
      

  


  

  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-SZB618VNBZ"),document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof location$&&location$.subscribe(function(t){gtag("config","G-SZB618VNBZ",{page_path:t.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SZB618VNBZ"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="blue">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Juniper Documentation" class="md-header__button md-logo" aria-label="Juniper Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Juniper Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              kubernetes #
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m10-3a5 5 0 0 1 5 5 5 5 0 0 1-5 5H7a5 5 0 0 1-5-5 5 5 0 0 1 5-5h10M7 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3h10a3 3 0 0 0 3-3 3 3 0 0 0-3-3H7z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/cal-itp/data-infra/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Welcome
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../datasets/01_overview/" class="md-tabs__link">
        Datasets
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        Kubernetes
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../services/gtfs-ckan-uploader/" class="md-tabs__link">
        Services
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../warehouse/01_agencies/" class="md-tabs__link">
        Warehouse
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Juniper Documentation" class="md-nav__button md-logo" aria-label="Juniper Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Juniper Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/cal-itp/data-infra/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Datasets
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Datasets" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Datasets
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/01_overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/gtfs_schedule/" class="md-nav__link">
        GTFS Schedule
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/mst_payments/" class="md-nav__link">
        MST Payments
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/transitstacks/" class="md-nav__link">
        Transitstacks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/views/" class="md-nav__link">
        Views
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          kubernetes #
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        kubernetes #
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cluster-administration" class="md-nav__link">
    Cluster Administration
  </a>
  
    <nav class="md-nav" aria-label="Cluster Administration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preflight" class="md-nav__link">
    preflight
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    quick start
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-lifecycle" class="md-nav__link">
    cluster lifecycle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodepool-lifecycle" class="md-nav__link">
    nodepool lifecycle
  </a>
  
    <nav class="md-nav" aria-label="nodepool lifecycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-new-node-pool" class="md-nav__link">
    create a new node pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drain-and-delete-an-old-node-pool" class="md-nav__link">
    drain and delete an old node pool
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-cluster-workloads" class="md-nav__link">
    Deploy Cluster Workloads
  </a>
  
    <nav class="md-nav" aria-label="Deploy Cluster Workloads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-workloads" class="md-nav__link">
    system workloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app-metabase" class="md-nav__link">
    app: metabase
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app-gtfs-rt-archive" class="md-nav__link">
    app: gtfs-rt-archive
  </a>
  
    <nav class="md-nav" aria-label="app: gtfs-rt-archive">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-service-versions" class="md-nav__link">
    new service versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agencies-data" class="md-nav__link">
    agencies data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Services
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Services" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../services/gtfs-ckan-uploader/" class="md-nav__link">
        GTFS CKAN Uploader
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../services/gtfs-rt-archive/" class="md-nav__link">
        gtfs-rt-archive
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Warehouse
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Warehouse" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Warehouse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../warehouse/01_agencies/" class="md-nav__link">
        Agency GTFS Feeds
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../warehouse/02_views/" class="md-nav__link">
        Creating New Tables (Views)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../warehouse/03_metrics/" class="md-nav__link">
        Metric Views
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../warehouse/04_sql_snippets/" class="md-nav__link">
        SQL Snippets
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../warehouse/table_names/" class="md-nav__link">
        Table names
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cluster-administration" class="md-nav__link">
    Cluster Administration
  </a>
  
    <nav class="md-nav" aria-label="Cluster Administration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preflight" class="md-nav__link">
    preflight
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    quick start
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-lifecycle" class="md-nav__link">
    cluster lifecycle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodepool-lifecycle" class="md-nav__link">
    nodepool lifecycle
  </a>
  
    <nav class="md-nav" aria-label="nodepool lifecycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-new-node-pool" class="md-nav__link">
    create a new node pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drain-and-delete-an-old-node-pool" class="md-nav__link">
    drain and delete an old node pool
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-cluster-workloads" class="md-nav__link">
    Deploy Cluster Workloads
  </a>
  
    <nav class="md-nav" aria-label="Deploy Cluster Workloads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-workloads" class="md-nav__link">
    system workloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app-metabase" class="md-nav__link">
    app: metabase
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app-gtfs-rt-archive" class="md-nav__link">
    app: gtfs-rt-archive
  </a>
  
    <nav class="md-nav" aria-label="app: gtfs-rt-archive">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-service-versions" class="md-nav__link">
    new service versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agencies-data" class="md-nav__link">
    agencies data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cal-itp/data-infra/edit/main/docs/kubernetes/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="kubernetes">kubernetes<a class="headerlink" href="#kubernetes" title="Permanent link"> ¶</a></h1>
<h2 id="cluster-administration">Cluster Administration<a class="headerlink" href="#cluster-administration" title="Permanent link"> ¶</a></h2>
<h3 id="preflight">preflight<a class="headerlink" href="#preflight" title="Permanent link"> ¶</a></h3>
<p>Check logged in user</p>
<div class="highlight"><pre><span></span><code>gcloud auth list
<span class="c1"># ensure correct active user</span>
<span class="c1"># gcloud auth login</span>
</code></pre></div>
<p>Check active project</p>
<div class="highlight"><pre><span></span><code>gcloud config get-value project
<span class="c1"># project should be cal-itp-data-infra</span>
<span class="c1"># gcloud config set project cal-itp-data-infra</span>
</code></pre></div>
<p>Check compute region</p>
<div class="highlight"><pre><span></span><code>gcloud config get-value compute/region
<span class="c1"># region should be us-west1</span>
<span class="c1"># gcloud config set compute/region us-west1</span>
</code></pre></div>
<h3 id="quick-start">quick start<a class="headerlink" href="#quick-start" title="Permanent link"> ¶</a></h3>
<div class="highlight"><pre><span></span><code>./kubernetes/gke/cluster-create.sh
<span class="c1"># ...</span>
<span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$PWD</span>/kubernetes/gke/kube/admin.yaml
kubectl cluster-info
</code></pre></div>
<h3 id="cluster-lifecycle">cluster lifecycle<a class="headerlink" href="#cluster-lifecycle" title="Permanent link"> ¶</a></h3>
<p>Create the cluster by running <code>kubernetes/gke/cluster-create.sh</code>.</p>
<p>The cluster level configuration parameters are stored in
<a href="../kubernetes/gke/config-cluster.sh"><code>kubernetes/gke/config-cluster.sh</code></a>.
Creating the cluster also requires configuring parameters for a node pool
named &ldquo;default-pool&rdquo; (unconfigurable name defined by GKE) in
<a href="../kubernetes/gke/config-nodepool.sh"><code>kubernetes/gke/config-nodepool.sh</code></a>.
Any additional node pools configured in this file are also stood up at cluster
creation time.</p>
<p>Once the cluster is created, it can be managed by pointing the <code>KUBECONFIG</code>
environment variable to <code>kubernetes/gke/kube/admin.yaml</code>.</p>
<p>The cluster can be deleted by running <code>kubernetes/gke/cluster-delete.sh</code>.</p>
<h3 id="nodepool-lifecycle">nodepool lifecycle<a class="headerlink" href="#nodepool-lifecycle" title="Permanent link"> ¶</a></h3>
<p>Certain features of node pools are immutable (e.g., machine type); to change
such parameters requires creating a new node pool with the desired new values,
migrating workloads off of the old node pool, and then deleting the old node pool.
The node pool lifecycle scripts help simplify this process.</p>
<h4 id="create-a-new-node-pool">create a new node pool<a class="headerlink" href="#create-a-new-node-pool" title="Permanent link"> ¶</a></h4>
<p>Configure a new node pool by adding its name to the <code>GKE_NODEPOOL_NAMES</code> array
in <a href="../kubernetes/gke/config-nodepool.sh"><code>kubernetes/gke/config-nodepool.sh</code></a>.
For each nodepool property (<code>GKE_NODEPOOL_NODE_COUNT</code>, <code>GKE_NODEPOOL_NODE_LOCATIONS</code>, etc)
it is required to add an entry to the array which is mapped to the nodepool name.</p>
<p>Once the new nodepool is configured, it can be stood up by running <code>kubernetes/gke/nodepool-up.sh [nodepool-name]</code>,
or by simply running <code>kubernetes/gke/nodepool-up.sh</code>, which will stand up all configured node pools which do not yet
exist.</p>
<h4 id="drain-and-delete-an-old-node-pool">drain and delete an old node pool<a class="headerlink" href="#drain-and-delete-an-old-node-pool" title="Permanent link"> ¶</a></h4>
<p>Once a new nodepool has been created to replace an active node pool, the old node pool must be
removed from the <code>GKE_NODEPOOL_NAMES</code> array.</p>
<p>Once the old node pool is removed from the array, it can be drained and deleted by running <code>kubernetes/gke/nodepool-down.sh &lt;nodepool-name&gt;</code>.</p>
<h2 id="deploy-cluster-workloads">Deploy Cluster Workloads<a class="headerlink" href="#deploy-cluster-workloads" title="Permanent link"> ¶</a></h2>
<p>Cluster workloads are divided into two classes:</p>
<ol>
<li>system</li>
<li>apps</li>
</ol>
<p>Apps are the workloads that users actually care about.</p>
<h3 id="system-workloads">system workloads<a class="headerlink" href="#system-workloads" title="Permanent link"> ¶</a></h3>
<div class="highlight"><pre><span></span><code>kubectl apply -k kubernetes/system
</code></pre></div>
<p>System workloads are used to support running applications. This includes items
such as an ingress controller, monitoring, logging, etc. The system deploy command
is run at cluster create time, but when new system workloads are added it may need
to be run again.</p>
<h3 id="app-metabase">app: metabase<a class="headerlink" href="#app-metabase" title="Permanent link"> ¶</a></h3>
<p>First deploy:</p>
<div class="highlight"><pre><span></span><code>helm install metabase kubernetes/apps/charts/metabase -f kubernetes/apps/values/metabase.yaml -n metabase --create-namespace
</code></pre></div>
<p>Apply changes:</p>
<div class="highlight"><pre><span></span><code>helm upgrade metabase kubernetes/apps/charts/metabase -f kubernetes/apps/values/metabase.yaml -n metabase
</code></pre></div>
<h3 id="app-gtfs-rt-archive">app: gtfs-rt-archive<a class="headerlink" href="#app-gtfs-rt-archive" title="Permanent link"> ¶</a></h3>
<p>First deploy:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Archive url: https://bitwarden.jarv.us//attachments/1ef9cad1-40a3-41f2-963d-f43d64c06efb/09dd10cd528b5f9743f3</span>
tar xzvf kubernetes-secrets.tar.gz <span class="o">&amp;&amp;</span> rm kubernetes-secrets.tar.gz

<span class="c1"># Deploy app</span>
kubectl apply -k kubernetes/secrets
kubectl apply -k kubernetes/apps/overlays/gtfs-rt-<span class="si">${</span><span class="nv">environment</span><span class="si">}</span>
</code></pre></div>
<p>Apply changes:</p>
<div class="highlight"><pre><span></span><code>kubectl apply -k kubernetes/apps/overlays/gtfs-rt-<span class="si">${</span><span class="nv">environment</span><span class="si">}</span>
</code></pre></div>
<h4 id="new-service-versions">new service versions<a class="headerlink" href="#new-service-versions" title="Permanent link"> ¶</a></h4>
<p>In order to deploy a new version of the service script, a container image of the new version needs to
be built and pushed to the GCR repository (see the <a href="../services/gtfs-rt-archive/">service documentation</a>
for details). Once there, the image version must be changed in <code>kubernetes/apps/overlays/gtfs-rt-${environmnt}/kustomization.yaml</code>
and the manifest change must then be applied (see: &ldquo;Apply changes&rdquo; above).</p>
<h4 id="agencies-data">agencies data<a class="headerlink" href="#agencies-data" title="Permanent link"> ¶</a></h4>
<p>The secret in <code>kubernetes/secrets/agencies-data.yaml</code> is a complete base64 encoded version
of the rendered agencies.yml file. When there are changes to the agencies file, the following
steps are required:</p>
<ol>
<li>Update the base64 data in <code>kubernetes/secrets/agencies-data.yaml</code> to contain the new agencies.yml contents</li>
<li>Upload the new data to the kubernetes API server</li>
<li><code>kubectl apply -f kubernetes/secrets/agencies-data.yaml</code></li>
<li>Restart the kubernetes deployment</li>
<li><code>kubectl -n gtfs-rt rollout restart deployment/gtfs-rt-archive</code></li>
</ol>
<p>See the <a href="../services/gtfs-rt-archive/">gtfs-rt-archive service documentation</a> for details on downloading the
latest agencies file</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../datasets/views/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Views" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Views
            </div>
          </div>
        </a>
      
      
        
        <a href="../services/gtfs-ckan-uploader/" class="md-footer__link md-footer__link--next" aria-label="Next: GTFS CKAN Uploader" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              GTFS CKAN Uploader
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.409db549.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56a63758.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.0/dist/mermaid.min.js"></script>
      
    
  </body>
</html>