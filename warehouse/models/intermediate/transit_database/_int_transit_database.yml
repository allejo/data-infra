version: 2

models:

  - name: int_transit_database__service_components_unnested
    description: |
      Version of `stg_transit_database__service_components` with all
      service, product, and component keys unnested.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - key
            - service_key
            - product_key
            - component_key
            - dt
      - dbt_utils.unique_combination_of_columns:
          severity: warn
          combination_of_columns:
            - service_key
            - product_key
            - component_key
            - dt
  - name: int_transit_database__urls_to_gtfs_datasets
    description: |
      Creates a 1:N relationship so any given extract/URL in the
      GTFS models can identify its source gtfs_datasets record.
      Currently this is unversioned; any historical URLs point
      to the latest version of their gtfs_datasets record.
    tests:
      - dbt_utils.mutually_exclusive_ranges:
          lower_bound_column: _valid_from
          upper_bound_column: _valid_to
          partition_by: base64_url
          gaps: required
    columns:
      - name: base64_url
        tests:
          - not_null
      - name: gtfs_dataset_key
        tests:
          - relationships:
              to: ref('dim_gtfs_datasets')
              field: key
              config:
                # four SMART urls and two test URLs that have been removed
                # will work once the dim is historical
                error_if: ">10"
                warn_if: ">0"
  - name: int_transit_database__services_daily_history
    description: |
      Service records in effect on a given day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - key
            - date
    columns:
      - name: date
        description: |
          Date on which this service was in our Transit Database data.
      - name: key
        description: |
          Foreign key to `dim_services`.
  - name: int_transit_database__organizations_daily_history
    description: |
      Organization records in effect on a given day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - key
            - date
    columns:
      - name: date
        description: |
          Date on which this organization was in our Transit Database data.
      - name: key
        description: |
          Foreign key to `dim_organizations`.
  - name: int_transit_database__gtfs_service_data_daily_history
    description: |
      GTFS service data records in effect on a given day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - key
            - date
    columns:
      - name: date
        description: |
          Date on which this GTFS service data record was in our Transit Database data.
      - name: key
        description: |
          Foreign key to `dim_gtfs_service_data`.
  - name: int_transit_database__gtfs_datasets_daily_history
    description: |
      GTFS dataset records in effect on a given day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - key
            - date
    columns:
      - name: date
        description: |
          Date on which this service was in our Transit Database data.
      - name: key
        description: |
          Foreign key to `dim_gtfs_datasets`.
  - name: int_transit_database__bridge_organizations_x_services_managed_daily_history
    description: |
      Organization/service relationships in effect on a given day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - organization_key
            - service_key
            - date
    columns:
      - name: date
        description: |
          Date on which this relationship was in our Transit Database data.
      - name: organization_key
        description: |
          Foreign key to `dim_organizations`.
      - name: service_key
        description: |
          Foreign key to `dim_services`.
  - name: int_transit_database__bridge_schedule_dataset_for_validation_daily_history
    description: |
      GTFS RT dataset/GTFS schedule dataset validation relationships in effect on a given day.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - gtfs_dataset_key
            - schedule_to_use_for_rt_validation_gtfs_dataset_key
            - date
    columns:
      - name: date
        description: |
          Date on which this relationship was in our Transit Database data.
      - name: gtfs_dataset_key
        description: |
          Foreign key to `dim_gtfs_datasets`.
      - name: schedule_to_use_for_rt_validation_gtfs_dataset_key
        description: |
          Key for the GTFS schedule dataset used to validation this dataset on this date.
