
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Querying GTFS in the Data Warehouse &#8212; Cal-ITP Data Services</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="More Complex Queries" href="new_tutorial.html" />
    <link rel="prev" title="Analysis Tutorials" href="overview.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SZB618VNBZ"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-SZB618VNBZ');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/calitp_logo_MAIN.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Cal-ITP Data Services</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Data Services Documentation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Analysts
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_welcome/overview.html">
   Welcome!
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/what_is_calitp.html">
     Cal-ITP Project Information
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_welcome/how_we_work.html">
     How We Work
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analytics_onboarding/overview.html">
   Technical Onboarding
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_tools/overview.html">
   Introduction to Analytics Tools
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/tools_quick_links.html">
     Tools Quick Links
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/bi_dashboards.html">
     Business Insights &amp; Dashboards
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/notebooks.html">
     Notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/python_libraries.html">
     Python Libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/saving_code.html">
     Saving Code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/storing_data.html">
     Storing Data During Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/data_catalogs.html">
     Using Data Catalogs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_tools/knowledge_sharing.html">
     Helpful Links
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../analytics_new_analysts/overview.html">
   Tutorials for New Python Users
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/data-analysis-intro.html">
     Data Analysis: Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/data-analysis-intermediate.html">
     Data Analysis: Intermediate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/data-management.html">
     Data Management
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/notebooks.html">
     Working with Jupyter notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/spatial-analysis-basics.html">
     Working with Geospatial Data: Basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/spatial-analysis-intro.html">
     Working with Geospatial Data: Intro
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/spatial-analysis-intermediate.html">
     Working with Geospatial Data: Intermediate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../analytics_new_analysts/spatial-analysis-advanced.html">
     Working with Geospatial Data: Advanced
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../warehouse/overview.html">
   Introduction to the Warehouse
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/table_naming.html">
     Table Naming
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/adding_oneoff_data.html">
     Adding Data to the Warehouse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/metrics.html">
     Metric Views
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../warehouse/sql_snippets.html">
     Helpful SQL Snippets
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../datasets_and_tables/overview.html">
   Datasets &amp; Tables
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/amplitude.html">
     Amplitude
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/gtfs_schedule.html">
     GTFS Schedule (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/mst_payments.html">
     MST Payments (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/transitdatabase.html">
     Transit Database
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/views.html">
     Views (WIP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../datasets_and_tables/tables.html">
     Tables (WIP)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="overview.html">
   Analysis Tutorials
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Querying GTFS in the Data Warehouse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="new_tutorial.html">
     More Complex Queries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sample-catalog-viewer.html">
     Sample Data Catalog
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../publishing/overview.html">
   Where can I publish data?
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/1_publishing_principles.html">
     Data Publishing Principles
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/2_static_files.html">
     Static Visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/3_github_pages.html">
     HTML Visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/4_analytics_portfolio_site.html">
     The Cal-ITP Analytics Portfolio
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/5_notebooks_styling.html">
     Getting Notebooks Ready for the Portfolio
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/6_metabase.html">
     Metabase
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/7_gcs.html">
     GCS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/8_ckan.html">
     Publishing data to California Open Data aka CKAN
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../publishing/sections/9_map_tiles.html">
     Map tiles
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developers
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../architecture/architecture_overview.html">
   Architecture Overview
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../airflow/overview.html">
   Airflow
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../airflow/local-setup.html">
     Local Airflow
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../airflow/static-schedule-pipeline.html">
     Static Schedule Pipeline
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../airflow/production-maintenance.html">
     Production Maintenance
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../airflow/dags-maintenance.html">
     DAGs Maintenance
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../airflow/agencies.html">
     Agency GTFS Feeds
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../airflow/views.html">
     Creating New Tables (Views)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../kubernetes/README.html">
   Kubernetes
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../kubernetes/JupyterHub.html">
     JupyterHub
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../kubernetes/architecture.html">
     architecture
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../kubernetes/deployment.html">
     deployment
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ci/README.html">
   CI
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/Git-Flow-Services.html">
     Git Flow for Services
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/Pipeline-Variables.html">
     Pipeline Variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/build-docker-image.html">
     build-docker-image
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/build-git-notes.html">
     build-git-notes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/build-git-tag.html">
     build-git-tag
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/configure-build-git-notes.html">
     configure-build-git-notes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/configure-docker-login.html">
     configure-docker-login
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/configure-git-remote.html">
     configure-git-remote
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/release-kube-overlay.html">
     release-kube-overlay
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/validate-build-git-tag.html">
     validate-build-git-tag
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ci/steps/validate-clean-worktree.html">
     validate-clean-worktree
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../github/contribute_to_repos.html">
   Contributing to data services repos
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../services/overview.html">
   Services
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../services/gtfs-ckan-uploader.html">
     GTFS CKAN Uploader
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../services/gtfs-rt-archive.html">
     gtfs-rt-archive
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../backups/metabase.html">
   Backups
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contribute to the Docs!
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contribute/overview.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/contribute-best-practices.html">
     Best Practices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/submitting_changes.html">
     Submitting Changes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contribute/content_types.html">
     Common Content
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/analytics_examples/warehouse_tutorial.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/analytics_examples/warehouse_tutorial.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/cal-itp/data-infra/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/cal-itp/data-infra//issues/new?title=Issue%20on%20page%20%2Fanalytics_examples/warehouse_tutorial.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/cal-itp/data-infra/edit/main/docs/analytics_examples/warehouse_tutorial.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/cal-itp/data-infra/main?urlpath=tree/docs/analytics_examples/warehouse_tutorial.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-queries">
     Example Queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tools-used">
     Tools Used
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#relevant-tables">
     Relevant Tables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#important-column-types">
     Important Column Types
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-examples">
   Query Examples
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-routes-for-a-given-agency-over-time">
     1. Number of Routes for a Given Agency Over Time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stops-for-a-given-agency-over-time">
     2. Number of Stops for a Given Agency Over Time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#for-a-given-agency-on-each-day-days-until-the-feed-expires">
     3. For a Given Agency, on Each Day, Days Until the Feed Expires
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stops-made-across-all-trips-for-an-agency">
     4. Number of Stops Made Across all Trips for an Agency
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#find-the-trip-with-the-most-number-of-stops-per-agency">
     5. Find the Trip With the Most Number of Stops, Per Agency
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Querying GTFS in the Data Warehouse</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-queries">
     Example Queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tools-used">
     Tools Used
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#relevant-tables">
     Relevant Tables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#important-column-types">
     Important Column Types
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-examples">
   Query Examples
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-routes-for-a-given-agency-over-time">
     1. Number of Routes for a Given Agency Over Time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stops-for-a-given-agency-over-time">
     2. Number of Stops for a Given Agency Over Time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#for-a-given-agency-on-each-day-days-until-the-feed-expires">
     3. For a Given Agency, on Each Day, Days Until the Feed Expires
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stops-made-across-all-trips-for-an-agency">
     4. Number of Stops Made Across all Trips for an Agency
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#find-the-trip-with-the-most-number-of-stops-per-agency">
     5. Find the Trip With the Most Number of Stops, Per Agency
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="querying-gtfs-in-the-data-warehouse">
<span id="warehouse-tutorial"></span><h1>Querying GTFS in the Data Warehouse<a class="headerlink" href="#querying-gtfs-in-the-data-warehouse" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The following content represents a tutorial introduction to simple queries that can be made to the calitp data warehouse, and the methods that can be used to perform them.</p>
<div class="section" id="example-queries">
<h3>Example Queries<a class="headerlink" href="#example-queries" title="Permalink to this headline">¶</a></h3>
<p>The queries represented in the following tutorial are as follows:</p>
<ol class="simple">
<li><p><a class="reference internal" href="#routes-agency-time"><span class="std std-ref"><strong>Number of Routes for a Given Agency Over Time</strong></span></a></p></li>
<li><p><a class="reference internal" href="#stops-agency-time"><span class="std std-ref"><strong>Number of Stops for a Given Agency Over Time</strong></span></a></p></li>
<li><p><a class="reference internal" href="#days-feed-expires"><span class="std std-ref"><strong>For a Given Agency, on Each Day, Days Until the Feed Expires</strong></span></a></p></li>
<li><p><a class="reference internal" href="#stops-all-trips"><span class="std std-ref"><strong>Number of Stops Made Across all Trips for an Agency</strong></span></a></p></li>
<li><p><a class="reference internal" href="#max-number-stops"><span class="std std-ref"><strong>Max Number of Stops a Trip Can Have, Per Agency</strong></span></a></p></li>
</ol>
</div>
<div class="section" id="tools-used">
<h3>Tools Used<a class="headerlink" href="#tools-used" title="Permalink to this headline">¶</a></h3>
<p>The tools that we can use to answer them are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../analytics_tools/bi_dashboards.html#metabase"><span class="std std-ref"><strong>Metabase</strong></span></a> - our business insights and dashboarding tool</p></li>
<li><p><a class="reference internal" href="../analytics_tools/notebooks.html#querying-sql-jupyterhub"><span class="std std-ref"><strong>SQL</strong></span></a> - using JupyterHub cloud notebooks</p></li>
<li><p><a class="reference internal" href="../analytics_tools/notebooks.html#jupyterhub"><span class="std std-ref"><strong>Python</strong></span></a> - using JupyterHub cloud notebooks</p>
<ul>
<li><p><em>siuba</em> - a Cal-ITP recommended data analysis library in Python</p></li>
<li><p><em>calitp</em> - Cal-ITP’s internal Python library</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="relevant-tables">
<h3>Relevant Tables<a class="headerlink" href="#relevant-tables" title="Permalink to this headline">¶</a></h3>
<div class="tabbed-set docutils">
<input checked="checked" id="5ad5e2d1-e9b6-48e2-87b6-b5bded59808d" name="19bf1634-dd48-4324-93ca-203b15f04074" type="radio">
</input><label class="tabbed-label" for="5ad5e2d1-e9b6-48e2-87b6-b5bded59808d">
Fact Tables</label><div class="tabbed-content docutils">
<p>These tables contain measurements, metrics, and facts used to answer the questions from the following perspectives:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Table Type</p></th>
<th class="head"><p>Location</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Feeds</strong></p></td>
<td><p>Warehouse: <code class="docutils literal notranslate"><span class="pre">views.gtfs_schedule_fact_daily_feeds</span></code> <br/> Metabase: <code class="docutils literal notranslate"><span class="pre">Gtfs</span> <span class="pre">Schedule</span> <span class="pre">Fact</span> <span class="pre">Daily</span> <span class="pre">Feeds</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Routes</strong></p></td>
<td><p>Warehouse: <code class="docutils literal notranslate"><span class="pre">views.gtfs_schedule_fact_daily_feed_routes</span></code> <br/> Metabase: <code class="docutils literal notranslate"><span class="pre">Gtfs</span> <span class="pre">Schedule</span> <span class="pre">Fact</span> <span class="pre">Daily</span> <span class="pre">Feed</span> <span class="pre">Routes</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Stops</strong></p></td>
<td><p>Warehouse: <code class="docutils literal notranslate"><span class="pre">views.gtfs_schedule_fact_daily_feed_stops</span></code> <br/> Metabase: <code class="docutils literal notranslate"><span class="pre">Gtfs</span> <span class="pre">Schedule</span> <span class="pre">Fact</span> <span class="pre">Daily</span> <span class="pre">Feed</span> <span class="pre">Stops</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Trips</strong></p></td>
<td><p>Warehouse: <code class="docutils literal notranslate"><span class="pre">views.gtfs_schedule_data_feed_trip_stops_latest</span></code> <br/> Metabase: <code class="docutils literal notranslate"><span class="pre">Gtfs</span> <span class="pre">Schedule</span> <span class="pre">Data</span> <span class="pre">Feed</span> <span class="pre">Trip</span> <span class="pre">Stops</span> <span class="pre">Latest</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<input id="d1adb228-69a5-4672-9a0a-abd048be30f1" name="19bf1634-dd48-4324-93ca-203b15f04074" type="radio">
</input><label class="tabbed-label" for="d1adb228-69a5-4672-9a0a-abd048be30f1">
Dimensional Tables</label><div class="tabbed-content docutils">
<p>These tables compliment the fact tables by providing additional descriptive attributes:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Table</p></th>
<th class="head"><p>Location</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Dim Feeds</strong></p></td>
<td><p>Warehouse: <code class="docutils literal notranslate"><span class="pre">views.gtfs_schedule_dim_feeds</span></code> <br/> Metabase: <code class="docutils literal notranslate"><span class="pre">Gtfs</span> <span class="pre">Schedule</span> <span class="pre">Dim</span> <span class="pre">Feeds</span></code></p></td>
<td><p>- Joining with this table is the most common way to append <code class="docutils literal notranslate"><span class="pre">calitp_feed_name</span></code> to fact tables <br/> - <code class="docutils literal notranslate"><span class="pre">calitp_feed_name</span></code> is our primary agency identifier</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="important-column-types">
<h3>Important Column Types<a class="headerlink" href="#important-column-types" title="Permalink to this headline">¶</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Column Type</p></th>
<th class="head"><p>Notable Columns</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Agency</strong></p></td>
<td><p>Warehouse: <code class="docutils literal notranslate"><span class="pre">calitp_feed_name</span></code> <br/> Metabase: <code class="docutils literal notranslate"><span class="pre">Calitp</span> <span class="pre">Feed</span> <span class="pre">Name</span></code></p></td>
<td><p>- Our primary agency identifier <br/> - In most of the examples below, this is gathered from the table: <code class="docutils literal notranslate"><span class="pre">views.gtfs_schedule_dim_feeds</span></code> <br/> - Metabase: <code class="docutils literal notranslate"><span class="pre">Gtfs</span> <span class="pre">Schedule</span> <span class="pre">Dim</span> <span class="pre">Feeds</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Time</strong></p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p><strong>Geography</strong></p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="query-examples">
<h2>Query Examples<a class="headerlink" href="#query-examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="number-of-routes-for-a-given-agency-over-time">
<span id="routes-agency-time"></span><h3>1. Number of Routes for a Given Agency Over Time<a class="headerlink" href="#number-of-routes-for-a-given-agency-over-time" title="Permalink to this headline">¶</a></h3>
<p>This example query uses a fact table describing routes joined with a dimensional table which enriches our data with agency information. We then count the number of routes an agency has published over time.</p>
<div class="tabbed-set docutils">
<input checked="checked" id="60d9be6c-312e-4de1-bdb0-1decefd89b68" name="38284dbd-8d7b-4153-a32b-21d312cf7c3a" type="radio">
</input><label class="tabbed-label" for="60d9be6c-312e-4de1-bdb0-1decefd89b68">
Metabase</label><div class="tabbed-content docutils">
<p><em>You can view this query in Metabase <a class="reference external" href="https://dashboards.calitp.org/question/215-1-number-of-routes-for-a-given-agency-over-time/notebook">using this link</a></em></p>
<p><img alt="Collection Matrix" src="../_images/routes_agency_over_time.png" /></p>
</div>
<input id="a41f98ff-a890-4938-8510-f108a49c9e89" name="38284dbd-8d7b-4153-a32b-21d312cf7c3a" type="radio">
</input><label class="tabbed-label" for="a41f98ff-a890-4938-8510-f108a49c9e89">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query SQL in the JupyterLab notebook</span>
<span class="c1"># Use this in combination with &#39;%%sql&#39;, as seen below</span>
<span class="kn">import</span> <span class="nn">calitp.magics</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- The first two columns are the ones we will group by for the count</span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="p">,</span><span class="w">               </span><span class="c1">-- agency info</span>
<span class="w">    </span><span class="nb">date</span><span class="p">,</span><span class="w">                           </span><span class="c1">-- time info</span>

<span class="w">    </span><span class="c1">-- The aggregation itself</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_routes</span><span class="w"></span>

<span class="c1">-- Primary fact table, we need this because it contains route information for</span>
<span class="c1">-- each agency on each day</span>
<span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_fact_daily_feed_routes</span><span class="o">`</span><span class="w"></span>

<span class="c1">-- Enriching with information about feeds from dimensional table</span>
<span class="c1">-- This will include columns such as calitp_feed_name, etc..</span>
<span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_dim_feeds</span><span class="o">`</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">feed_key</span><span class="p">)</span><span class="w"></span>

<span class="c1">-- Filtering for agency, this column comes from the dimensional table above</span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;AC Transit (0)&quot;</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="c1">-- Note that 1, 2 refer to the first two columns of the select</span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="w">    </span><span class="nb">date</span><span class="w"> </span><span class="k">DESC</span><span class="w"></span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>calitp_feed_name</th>
      <th>date</th>
      <th>count_routes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AC Transit (0)</td>
      <td>2022-07-19</td>
      <td>85</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AC Transit (0)</td>
      <td>2022-07-18</td>
      <td>85</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AC Transit (0)</td>
      <td>2022-07-17</td>
      <td>85</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AC Transit (0)</td>
      <td>2022-07-16</td>
      <td>85</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AC Transit (0)</td>
      <td>2022-07-15</td>
      <td>85</td>
    </tr>
    <tr>
      <th>5</th>
      <td>AC Transit (0)</td>
      <td>2022-07-14</td>
      <td>85</td>
    </tr>
    <tr>
      <th>6</th>
      <td>AC Transit (0)</td>
      <td>2022-07-13</td>
      <td>85</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AC Transit (0)</td>
      <td>2022-07-12</td>
      <td>85</td>
    </tr>
    <tr>
      <th>8</th>
      <td>AC Transit (0)</td>
      <td>2022-07-11</td>
      <td>85</td>
    </tr>
    <tr>
      <th>9</th>
      <td>AC Transit (0)</td>
      <td>2022-07-10</td>
      <td>85</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<input id="7023ba82-cb27-4f90-b6ec-632808f636d0" name="38284dbd-8d7b-4153-a32b-21d312cf7c3a" type="radio">
</input><label class="tabbed-label" for="7023ba82-cb27-4f90-b6ec-632808f636d0">
siuba</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query tables in the warehouse</span>
<span class="kn">from</span> <span class="nn">calitp.tables</span> <span class="kn">import</span> <span class="n">tbl</span>

<span class="c1"># The data analysis library used</span>
<span class="kn">from</span> <span class="nn">siuba</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="c1"># Primary fact table, we need this because it contains route information</span>
    <span class="c1"># for each agency on each day</span>
    <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_fact_daily_feed_routes</span><span class="p">()</span>

    <span class="c1"># Enriching with information about feeds from dimensional table</span>
    <span class="c1"># This will include columns such as calitp_feed_name, etc..</span>
    <span class="o">&gt;&gt;</span> <span class="n">left_join</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_dim_feeds</span><span class="p">(),</span> <span class="s2">&quot;feed_key&quot;</span><span class="p">)</span>

    <span class="c1"># Filtering for agency, this column comes from the dimensional table above</span>
    <span class="o">&gt;&gt;</span> <span class="nb">filter</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span> <span class="o">==</span> <span class="s2">&quot;AC Transit (0)&quot;</span><span class="p">)</span>

    <span class="c1"># Group and count rows by date, effectively counting the number of routes</span>
    <span class="c1"># for a given agency over time</span>
    <span class="o">&gt;&gt;</span> <span class="n">count</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

    <span class="c1"># Sort by date</span>
    <span class="o">&gt;&gt;</span> <span class="n">arrange</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div><pre># Source: lazy query
# DB Conn: Engine(bigquery://cal-itp-data-infra/?maximum_bytes_billed=5000000000)
# Preview:
</pre><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2021-12-04</td>
      <td>129</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021-12-05</td>
      <td>129</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2021-12-06</td>
      <td>129</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021-12-07</td>
      <td>129</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2021-12-08</td>
      <td>129</td>
    </tr>
  </tbody>
</table>
</div><p># .. may have more rows</p></div></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="number-of-stops-for-a-given-agency-over-time">
<span id="stops-agency-time"></span><h3>2. Number of Stops for a Given Agency Over Time<a class="headerlink" href="#number-of-stops-for-a-given-agency-over-time" title="Permalink to this headline">¶</a></h3>
<p>This example query is very similar to the previous query, except that it substitutes the routes fact table with the stops fact table to count the number of stops an agency has published over time.</p>
<div class="tabbed-set docutils">
<input checked="checked" id="f3beed64-f456-40f7-a4a7-249687eb30c9" name="57aa76f5-4fe8-4809-9d36-6c9463490db9" type="radio">
</input><label class="tabbed-label" for="f3beed64-f456-40f7-a4a7-249687eb30c9">
Metabase</label><div class="tabbed-content docutils">
<p><em>You can view this query in Metabase <a class="reference external" href="https://dashboards.calitp.org/question/216-2-number-of-stops-for-a-given-agency-over-time/notebook">using this link</a></em></p>
<p><img alt="Collection Matrix" src="../_images/stops_agency_over_time.png" /></p>
</div>
<input id="2ed15cc4-43b1-4575-9380-b0c1c8c1bd4a" name="57aa76f5-4fe8-4809-9d36-6c9463490db9" type="radio">
</input><label class="tabbed-label" for="2ed15cc4-43b1-4575-9380-b0c1c8c1bd4a">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query SQL in the JupyterLab notebook</span>
<span class="c1"># Use this in combination with &#39;%%sql&#39;, as seen below</span>
<span class="kn">import</span> <span class="nn">calitp.magics</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- The first two columns are the ones we will group by for the count</span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="p">,</span><span class="w">               </span><span class="c1">-- agency info</span>
<span class="w">    </span><span class="nb">date</span><span class="p">,</span><span class="w">                           </span><span class="c1">-- time info</span>

<span class="w">    </span><span class="c1">-- The aggregation itself</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_stops</span><span class="w"></span>

<span class="c1">-- Primary fact table, we need this because it contains stops information for</span>
<span class="c1">-- each agency on each day</span>
<span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_fact_daily_feed_stops</span><span class="o">`</span><span class="w"></span>

<span class="c1">-- Enriching with information about feeds from dimensional table</span>
<span class="c1">-- This will include columns such as calitp_feed_name, etc..</span>
<span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_dim_feeds</span><span class="o">`</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">feed_key</span><span class="p">)</span><span class="w"></span>

<span class="c1">-- Filtering for agency, this column comes from the dimensional table above</span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;AC Transit (0)&quot;</span><span class="w"></span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- Note that 1, 2 refer to the first two columns of the select</span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="w">    </span><span class="nb">date</span><span class="w"></span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>calitp_feed_name</th>
      <th>date</th>
      <th>count_stops</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AC Transit (0)</td>
      <td>2021-04-15</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AC Transit (0)</td>
      <td>2021-04-16</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AC Transit (0)</td>
      <td>2021-04-17</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AC Transit (0)</td>
      <td>2021-04-18</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AC Transit (0)</td>
      <td>2021-04-19</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>5</th>
      <td>AC Transit (0)</td>
      <td>2021-04-20</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>6</th>
      <td>AC Transit (0)</td>
      <td>2021-04-21</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AC Transit (0)</td>
      <td>2021-04-22</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>8</th>
      <td>AC Transit (0)</td>
      <td>2021-04-23</td>
      <td>4579</td>
    </tr>
    <tr>
      <th>9</th>
      <td>AC Transit (0)</td>
      <td>2021-04-24</td>
      <td>4579</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<input id="5398c93b-eb53-4e06-97af-2f855860fce7" name="57aa76f5-4fe8-4809-9d36-6c9463490db9" type="radio">
</input><label class="tabbed-label" for="5398c93b-eb53-4e06-97af-2f855860fce7">
siuba</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query tables in the warehouse</span>
<span class="kn">from</span> <span class="nn">calitp.tables</span> <span class="kn">import</span> <span class="n">tbl</span>

<span class="c1"># The data analysis library used</span>
<span class="kn">from</span> <span class="nn">siuba</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## Join to get CalITP Feed Names</span>
<span class="c1">## Count stops by date and CalITP Feed Names, order by date, filter by specific calitp_feed_name</span>
<span class="p">(</span>
    <span class="c1"># Primary fact table, we need this because it contains stop information</span>
    <span class="c1"># for each agency on each day</span>
    <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_fact_daily_feed_stops</span><span class="p">()</span>

    <span class="c1"># Enriching with information about feeds from dimensional table</span>
    <span class="c1"># This will include columns such as calitp_feed_name, etc..</span>
    <span class="o">&gt;&gt;</span> <span class="n">left_join</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_dim_feeds</span><span class="p">(),</span> <span class="s2">&quot;feed_key&quot;</span><span class="p">)</span>

    <span class="c1"># Filtering for agency, this column comes from the dimensional table above</span>
    <span class="o">&gt;&gt;</span> <span class="nb">filter</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span> <span class="o">==</span> <span class="s2">&quot;AC Transit (0)&quot;</span><span class="p">)</span>

    <span class="c1"># Group and count rows by date and agency, effectively counting the number</span>
    <span class="c1"># of stops for a given agency over time</span>
    <span class="o">&gt;&gt;</span> <span class="n">count</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span><span class="p">)</span>

    <span class="c1"># Sort by date</span>
    <span class="o">&gt;&gt;</span> <span class="n">arrange</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div><pre># Source: lazy query
# DB Conn: Engine(bigquery://cal-itp-data-infra/?maximum_bytes_billed=5000000000)
# Preview:
</pre><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>calitp_feed_name</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2021-04-15</td>
      <td>AC Transit (0)</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021-04-16</td>
      <td>AC Transit (0)</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2021-04-17</td>
      <td>AC Transit (0)</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021-04-18</td>
      <td>AC Transit (0)</td>
      <td>4226</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2021-04-19</td>
      <td>AC Transit (0)</td>
      <td>4226</td>
    </tr>
  </tbody>
</table>
</div><p># .. may have more rows</p></div></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="for-a-given-agency-on-each-day-days-until-the-feed-expires">
<span id="days-feed-expires"></span><h3>3. For a Given Agency, on Each Day, Days Until the Feed Expires<a class="headerlink" href="#for-a-given-agency-on-each-day-days-until-the-feed-expires" title="Permalink to this headline">¶</a></h3>
<p>This query uses a fact table as we did in queries the previous two queries. However, instead of counting we pull out previously calculated table columns as important pieces of information.</p>
<div class="tabbed-set docutils">
<input checked="checked" id="496fcb98-c8ef-408b-a00c-6805f4949834" name="8b3307a9-bd1d-4c2f-8da0-c059b2164589" type="radio">
</input><label class="tabbed-label" for="496fcb98-c8ef-408b-a00c-6805f4949834">
Metabase</label><div class="tabbed-content docutils">
<p><em>You can view this query in Metabase <a class="reference external" href="https://dashboards.calitp.org/question/227-4-for-a-given-agency-on-each-day-days-until-the-feed-expires/notebook">using this link</a></em></p>
<p><img alt="Collection Matrix" src="../_images/days_until_agency_feed_expires.png" /></p>
</div>
<input id="5ca4aabe-9b5d-4376-a6a9-e95c0d3cfb8d" name="8b3307a9-bd1d-4c2f-8da0-c059b2164589" type="radio">
</input><label class="tabbed-label" for="5ca4aabe-9b5d-4376-a6a9-e95c0d3cfb8d">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query SQL in the JupyterLab notebook</span>
<span class="c1"># Use this in combination with &#39;%%sql&#39;, as seen below</span>
<span class="kn">import</span> <span class="nn">calitp.magics</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="p">,</span><span class="w">               </span><span class="c1">-- agency info</span>
<span class="w">    </span><span class="nb">date</span><span class="p">,</span><span class="w">                           </span><span class="c1">-- time info</span>
<span class="w">    </span><span class="n">days_until_feed_end_date</span><span class="p">,</span><span class="w">       </span><span class="c1">-- time until feed expires, for a given day</span>
<span class="w">    </span><span class="n">feed_end_date</span><span class="w">                   </span><span class="c1">-- the day the feed expires</span>

<span class="c1">-- Primary fact table, we need this because it contains information on</span>
<span class="c1">-- agency feeds</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_fact_daily_feeds</span><span class="w"></span>

<span class="c1">-- Enriching with information about feeds from dimensional table</span>
<span class="c1">-- This will include columns such as calitp_feed_name, etc..</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_dim_feeds</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">feed_key</span><span class="p">)</span><span class="w"></span>

<span class="c1">-- Filtering for our particular day and agency</span>
<span class="c1">-- The agency info column comes from the dimensional table above</span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">    </span><span class="nb">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;2021-09-01&quot;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">calitp_feed_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;AC Transit (0)&quot;</span><span class="w"></span>

<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>calitp_feed_name</th>
      <th>date</th>
      <th>days_until_feed_end_date</th>
      <th>feed_end_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AC Transit (0)</td>
      <td>2021-09-01</td>
      <td>108</td>
      <td>2021-12-18</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<input id="0f8e8681-fbae-4cc6-924a-17c635297a19" name="8b3307a9-bd1d-4c2f-8da0-c059b2164589" type="radio">
</input><label class="tabbed-label" for="0f8e8681-fbae-4cc6-924a-17c635297a19">
siuba</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query tables in the warehouse</span>
<span class="kn">from</span> <span class="nn">calitp.tables</span> <span class="kn">import</span> <span class="n">tbl</span>

<span class="c1"># The data analysis library used</span>
<span class="kn">from</span> <span class="nn">siuba</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="c1"># Primary fact table, we need this because it contains information on</span>
    <span class="c1"># agency feeds</span>
    <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_fact_daily_feeds</span><span class="p">()</span>

    <span class="c1"># Enriching with information about feeds from dimensional table</span>
    <span class="c1"># This will include columns such as calitp_feed_name, etc..</span>
    <span class="o">&gt;&gt;</span> <span class="n">left_join</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_dim_feeds</span><span class="p">(),</span> <span class="s2">&quot;feed_key&quot;</span><span class="p">)</span>

    <span class="c1"># Keeping the columns that we need for this query</span>
    <span class="o">&gt;&gt;</span> <span class="n">select</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span><span class="p">,</span> <span class="n">_</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">_</span><span class="o">.</span><span class="n">days_until_feed_end_date</span><span class="p">,</span> <span class="n">_</span><span class="o">.</span><span class="n">feed_end_date</span><span class="p">)</span>

    <span class="c1"># Filtering for our particular day and agency</span>
    <span class="o">&gt;&gt;</span> <span class="nb">filter</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="s2">&quot;2021-09-01&quot;</span><span class="p">,</span> <span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span> <span class="o">==</span> <span class="s2">&quot;AC Transit (0)&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div><pre># Source: lazy query
# DB Conn: Engine(bigquery://cal-itp-data-infra/?maximum_bytes_billed=5000000000)
# Preview:
</pre><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>calitp_feed_name</th>
      <th>date</th>
      <th>days_until_feed_end_date</th>
      <th>feed_end_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AC Transit (0)</td>
      <td>2021-09-01</td>
      <td>108</td>
      <td>2021-12-18</td>
    </tr>
  </tbody>
</table>
</div><p># .. may have more rows</p></div></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="number-of-stops-made-across-all-trips-for-an-agency">
<span id="stops-all-trips"></span><h3>4. Number of Stops Made Across all Trips for an Agency<a class="headerlink" href="#number-of-stops-made-across-all-trips-for-an-agency" title="Permalink to this headline">¶</a></h3>
<p>Instead of using fact or dimensional tables as in the examples above, this query and the next use a wide convenience table that was created to aggregate trip stops information from only the most recent feeds extracted. Information for the latest day can be found in this table.</p>
<p>We use this table to query an agency’s most recent feed published and count the total number of trip stops, as well as the number of distinct trips and stops that compose them.</p>
<div class="tabbed-set docutils">
<input checked="checked" id="3c89687e-89f2-45d3-94c9-4468a73ef2e0" name="66a288c8-bb04-4b0d-aa7d-4e657cad5e8a" type="radio">
</input><label class="tabbed-label" for="3c89687e-89f2-45d3-94c9-4468a73ef2e0">
Metabase</label><div class="tabbed-content docutils">
<p><em><strong>4A. Count of Trip Stops Made Across all Trips for an Agency</strong></em></p>
<p><em>You can view this query in Metabase <a class="reference external" href="https://dashboards.calitp.org/question/224-3a-count-of-trip-stops-made-across-all-trips-for-an-agency/notebook">using this link</a></em></p>
<p><img alt="Collection Matrix" src="../_images/count_trip_stops.png" /></p>
<p><em><strong>4B. Distinct Trips in Trip Stops</strong></em></p>
<p><em>You can view this query in Metabase <a class="reference external" href="https://dashboards.calitp.org/question/225-3b-distinct-trips-in-trip-stops-for-an-agency/notebook">using this link</a></em></p>
<p><img alt="Collection Matrix" src="../_images/distinct_trips_in_trip_stops.png" /></p>
<p><em><strong>4C. Distinct Stops in Trip Stops</strong></em></p>
<p><em>You can view this query in Metabase <a class="reference external" href="https://dashboards.calitp.org/question/226-3c-distinct-stops-in-trip-stops-for-an-agency/notebook">using this link</a></em></p>
<p><img alt="Collection Matrix" src="../_images/distinct_stops_in_trip_stops.png" /></p>
</div>
<input id="be841480-4f82-4302-ba0e-bdc63af29a74" name="66a288c8-bb04-4b0d-aa7d-4e657cad5e8a" type="radio">
</input><label class="tabbed-label" for="be841480-4f82-4302-ba0e-bdc63af29a74">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query SQL in the JupyterLab notebook</span>
<span class="c1"># Use this in combination with &#39;%%sql&#39;, as seen below</span>
<span class="kn">import</span> <span class="nn">calitp.magics</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- The first column is what we will group by</span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="p">,</span><span class="w">               </span><span class="c1">-- agency info</span>

<span class="w">    </span><span class="c1">-- Counting the total number of trip stops</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">n_trip_stops</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- Counting the number of unique trips</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="p">(</span><span class="n">trip_id</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">n_trips</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- Counting the number of unique stops</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="p">(</span><span class="n">stop_id</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">n_stops</span><span class="w"></span>

<span class="c1">-- Primary fact table, we need this because it contains trip stop information</span>
<span class="c1">-- for each agency on each day in the latest feed</span>
<span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_data_feed_trip_stops_latest</span><span class="o">`</span><span class="w"></span>

<span class="c1">-- Filtering for each agency</span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;AC Transit (0)&quot;</span><span class="w"></span>

<span class="c1">-- The column we need to group by</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="w"></span>

<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>calitp_feed_name</th>
      <th>n_trip_stops</th>
      <th>n_trips</th>
      <th>n_stops</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AC Transit (0)</td>
      <td>569473</td>
      <td>13130</td>
      <td>4179</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<input id="71b5c459-25a0-4da4-b168-54255d4f0404" name="66a288c8-bb04-4b0d-aa7d-4e657cad5e8a" type="radio">
</input><label class="tabbed-label" for="71b5c459-25a0-4da4-b168-54255d4f0404">
siuba</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query tables in the warehouse</span>
<span class="kn">from</span> <span class="nn">calitp.tables</span> <span class="kn">import</span> <span class="n">tbl</span>

<span class="c1"># The data analysis library used</span>
<span class="kn">from</span> <span class="nn">siuba</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="c1"># Primary fact table, we need this because it contains trip stop information</span>
    <span class="c1"># for each agency on each day in the latest feed</span>
    <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_data_feed_trip_stops_latest</span><span class="p">()</span>

    <span class="c1"># Filtering for agency</span>
    <span class="o">&gt;&gt;</span> <span class="nb">filter</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span> <span class="o">==</span> <span class="s2">&quot;AC Transit (0)&quot;</span><span class="p">)</span>

    <span class="c1"># using siuba and pandas to determine number of unique trips, number of</span>
    <span class="c1"># unique stops, and the total number of trip stops</span>
    <span class="o">&gt;&gt;</span> <span class="n">summarize</span><span class="p">(</span>
        <span class="n">n_trips</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">trip_id</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">n_stops</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">stop_id</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">n</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">trip_id</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div><pre># Source: lazy query
# DB Conn: Engine(bigquery://cal-itp-data-infra/?maximum_bytes_billed=5000000000)
# Preview:
</pre><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_trips</th>
      <th>n_stops</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13130</td>
      <td>4179</td>
      <td>569473</td>
    </tr>
  </tbody>
</table>
</div><p># .. may have more rows</p></div></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="find-the-trip-with-the-most-number-of-stops-per-agency">
<span id="max-number-stops"></span><h3>5. Find the Trip With the Most Number of Stops, Per Agency<a class="headerlink" href="#find-the-trip-with-the-most-number-of-stops-per-agency" title="Permalink to this headline">¶</a></h3>
<p>Similar to the previous query, this example uses the same wide convenience table. We use this table here to determine the trip that contains the most number of stops in the latest feed, by agency.</p>
<div class="tabbed-set docutils">
<input checked="checked" id="0f1fded5-712b-4cf1-95b8-e83514821eba" name="b5a4e190-f888-4202-9d90-cf2e465c3492" type="radio">
</input><label class="tabbed-label" for="0f1fded5-712b-4cf1-95b8-e83514821eba">
Metabase</label><div class="tabbed-content docutils">
<p><em>You can view this query in Metabase <a class="reference external" href="https://dashboards.calitp.org/question/223-5-find-the-trip-with-the-most-number-of-stops-per-agency/notebook">using this link</a></em></p>
<p><img alt="Collection Matrix" src="../_images/most_stops_per_trip_by_agency.png" /></p>
</div>
<input id="d53a293a-aff2-4a29-bbc9-dac4f0b4a04c" name="b5a4e190-f888-4202-9d90-cf2e465c3492" type="radio">
</input><label class="tabbed-label" for="d53a293a-aff2-4a29-bbc9-dac4f0b4a04c">
SQL</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query SQL in the JupyterLab notebook</span>
<span class="c1"># Use this in combination with &#39;%%sql&#39;, as seen below</span>
<span class="kn">import</span> <span class="nn">calitp.magics</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span><span class="w"></span>

<span class="c1">-- Using a WITH clause to create a sub-query counting the number of stops each</span>
<span class="c1">-- trip in each feed makes, to be referenced later in the query</span>
<span class="k">WITH</span><span class="w"></span>

<span class="c1">-- The name of the sub-query block to be referenced later</span>
<span class="n">counting_stop_times</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w"></span>

<span class="w">    </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">        </span><span class="c1">-- The first two columns are the ones we will group by for the count</span>
<span class="w">        </span><span class="n">trip_id</span><span class="p">,</span><span class="w">                        </span><span class="c1">-- unique trip identifier</span>
<span class="w">        </span><span class="n">calitp_feed_name</span><span class="p">,</span><span class="w">               </span><span class="c1">-- agency info</span>

<span class="w">        </span><span class="c1">-- The aggregation itself</span>
<span class="w">        </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">n_trip_stop_times</span><span class="w"></span>

<span class="w">    </span><span class="c1">-- Primary fact table, we need this because it contains trip stop</span>
<span class="w">    </span><span class="c1">-- information for each agency on each day in the latest feed</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">views</span><span class="p">.</span><span class="n">gtfs_schedule_data_feed_trip_stops_latest</span><span class="o">`</span><span class="w"></span>

<span class="w">    </span><span class="c1">-- Note that 1, 2 refer to the first two columns of the select</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- The first columns is the one we will group by for the count</span>
<span class="w">    </span><span class="c1">-- These columns come from the sub-query above</span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="p">,</span><span class="w">               </span><span class="c1">-- agency info</span>
<span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">n_trip_stop_times</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_n_trip_stop_times</span><span class="w"> </span><span class="c1">-- trip with most stops</span>

<span class="c1">-- The sub-query block we created above</span>
<span class="k">FROM</span><span class="w"></span>
<span class="w">    </span><span class="n">counting_stop_times</span><span class="w"></span>

<span class="c1">-- Filtering for agency</span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">     </span><span class="n">calitp_feed_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;AC Transit (0)&quot;</span><span class="w"></span>

<span class="c1">-- The column we need to group by</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="w">    </span><span class="n">calitp_feed_name</span><span class="w"></span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>calitp_feed_name</th>
      <th>max_n_trip_stop_times</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AC Transit (0)</td>
      <td>92</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<input id="1b9daec1-e085-476c-bb71-329767ad5bb9" name="b5a4e190-f888-4202-9d90-cf2e465c3492" type="radio">
</input><label class="tabbed-label" for="1b9daec1-e085-476c-bb71-329767ad5bb9">
siuba</label><div class="tabbed-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allows us to query tables in the warehouse</span>
<span class="kn">from</span> <span class="nn">calitp.tables</span> <span class="kn">import</span> <span class="n">tbl</span>

<span class="c1"># The data analysis library used</span>
<span class="kn">from</span> <span class="nn">siuba</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="c1"># Primary fact table, we need this because it contains trip stop information</span>
    <span class="c1"># for each agency on each day in the latest feed</span>
    <span class="n">tbl</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">gtfs_schedule_data_feed_trip_stops_latest</span><span class="p">()</span>

    <span class="c1"># Group and count rows by trip ID and agency, effectively counting the</span>
    <span class="c1"># number of stops for a given trip by agency in the latest feed</span>
    <span class="o">&gt;&gt;</span> <span class="n">count</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">trip_id</span><span class="p">,</span> <span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span><span class="p">)</span>

    <span class="c1"># Filtering for agency</span>
    <span class="o">&gt;&gt;</span> <span class="nb">filter</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">calitp_feed_name</span> <span class="o">==</span> <span class="s2">&quot;AC Transit (0)&quot;</span><span class="p">)</span>

    <span class="c1"># Find the trip with the largest number of stops</span>
    <span class="o">&gt;&gt;</span> <span class="n">summarize</span><span class="p">(</span><span class="n">n_max</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<div class="cell_output docutils container">
<div class="output text_html"><div><pre># Source: lazy query
# DB Conn: Engine(bigquery://cal-itp-data-infra/?maximum_bytes_billed=5000000000)
# Preview:
</pre><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>92</td>
    </tr>
  </tbody>
</table>
</div><p># .. may have more rows</p></div></div></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./analytics_examples"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="overview.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Analysis Tutorials</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="new_tutorial.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">More Complex Queries</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Cal-ITP<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>